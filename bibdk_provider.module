<?php

require_once('BibdkClientClass.php');

/**
 * Impelements hook_menu
 */

function bibdk_provider_menu() {
  $items['user/create_login'] = array(
				      //'page callback' => 'drupal_get_form',
      'page callback' => 'bibdk_provider_get_drupal_user_form',				     
      'access callback' => TRUE,
      //   'page arguments' => array('user_register_form'),
   );
    return $items;
}

function bibdk_provider_get_drupal_user_form() {
  return drupal_get_form('user_register_form');
  }

function bibdk_provider_form_user_register_form_submit( $form, &$form_state ) {
  
  dpm($form_state);
  $form_state['values']['name'] = $form_state['values']['mail'];
  
  // @TODO this is wrong .. use some hook
  user_register_submit($form, $form_state);
}

function bibdk_provider_form_user_register_form_alter( &$form, &$form_state) {
   $form['account']['name'] = array(
    '#access' => FALSE
    );
  


  $form['account']['mail']['#title'] = t('Username');

  $form['account']['password'] = array(
    '#type' => 'textfield',
    '#title' => t('Password'),
    '#default_value' => '',
    '#access' => '1',
    '#weight' => '10',
    '#required' => 1,
  );


  //@TODO this is wrong .. use some drupal method
  $form['#submit']=array();
  $form['#submit'][] = 'bibdk_provider_form_user_register_form_submit';

    $form['account']['confirm_password'] = array(
    '#type' => 'textfield',
    '#title' => t('Confirm password'),
    '#default_value' => '',
    '#access' => '1',
    '#weight' => '11',
    '#required' => 1,
    );
  
    dpm($form);

  $form['#validate'][] = 'bibdk_provider_user_register_form_validate';
}


/**
 * Implements hook_mail_alter
 */
function bibdk_provider_mail_alter(&$message) {
  dpm($message);
}

/**
 * Implements hook_mail
 */
function bibdk_provider_mail($key, &$message, $params) {
}


function bibdk_provider_user_register_form_validate(&$form,&$form_state) {
  if( $form_state['values']['confirm_password'] != $form_state['values']['password'] ){
    form_error($form['account']['password'], t('Mismatch in password and confirm password'));
    }
  //return false;
}



/**
 * Implement hook_ding_provider().
 */
function bibdk_provider_ding_provider() {
  return array(
    'title' => 'Bibliotek.dk provider',
    'settings' => 'bibdk_provider_settings_form',
    'provides' => array(
	'user' => array(
        'prefix' => 'user',
        'file' => drupal_get_path('module', 'bibdk_provider') . '/bibdk_provider.user.inc',
      ),
	/*      'availability' => array(
        'prefix' => 'availability',
        'file' => drupal_get_path('module', 'bibdk_provider') . '/bibdk_provider.availability.inc',
      ),
      
      'reservation' => array(
        'prefix' => 'reservation',
        'file' => drupal_get_path('module', 'bibdk_provider') . '/bibdk_provider.reservation.inc',
      ),
      'loan' => array(
        'prefix' => 'loan',
        'file' => drupal_get_path('module', 'bibdk_provider') . '/bibdk_provider.loan.inc',
      ),
      'debt' => array(
        'prefix' => 'debt',
        'file' => drupal_get_path('module', 'bibdk_provider') . '/bibdk_provider.debt.inc',
	),*/
    ),
  );
}

/**
 * Form callback for provider module settings.
 *
 * This is a regular form callback.
 */
function bibdk_provider_settings_form() {
  $form['bibdk_provider'] = array(
    '#type' => 'fieldset',
    '#title' => t('Bibdk provider service settings'),
    '#tree' => FALSE,
  );

  $form['bibdk_provider']['bibdk_provider_wsdl_url'] = array(
    '#type' => 'textfield',
    '#title' => t('Bibdk provider WSDL URL'),
    '#description' => t('The WSDL URL for Bibdk provider SOAP service, usually something like http://
/bibdk_provider.addi.dk/1.0/bibdk_provider.wsdl'),
    '#required' => TRUE,
    '#default_value' => variable_get('bibdk_provider_wsdl_url', ''),
  );

  //no need for an agencyid
  /*  $form['bibdk_provider']['bibdk_provider_agency_id'] = array(
    '#type' => 'textfield',
    '#title' => t('Agency Id'),
    '#default_value' => variable_get('bibdk_provider_agency_id', ''),
    '#description' => t('The Bibdk provider agency id of the library.'),
    );*/

  $form['bibdk_provider']['bibdk_provider_enable_logging'] = array(
    '#type' => 'checkbox',
    '#title' => t('Enable logging'),
    '#default_value' => variable_get('bibdk_provider_enable_logging', FALSE),
    '#description' => t('Logs requests to the Bibdk provider webservice. Sensitive information such 
as CPR number and PIN code is stripped from the requests.'),
  );

  return system_settings_form($form);
}
